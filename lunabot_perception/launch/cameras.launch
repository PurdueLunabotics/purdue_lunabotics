<?xml version="1.0"?>
<launch>
  <arg name="isTestBot" default="false"/>
  <arg name="serial_no_d455_back"    			    default="053122251286" unless="$(arg isTestBot)"/> 		
  <arg name="serial_no_d455_back"    			    default="141222070808" if="$(arg isTestBot)"/> 		
  <arg name="serial_no_d435_left"    			  default="141222070808"/> 	
  <arg name="serial_no_d455_front"    			  default="053122251335" unless="$(arg isTestBot)"/> 	
  <arg name="serial_no_d455_front"    			  default="939622074382" if="$(arg isTestBot)"/> 	
  <arg name="serial_no_d435_right"    			  default="939622074382"/> 	
  
  <arg name="initial_reset"                   default="true"/>
  <arg name="sim"                             default="false"/>
  <arg name="width"                           default="424"/>
  <arg name="height"                          default="240"/>
  <arg name="fps"                             default="30"/>
  <arg name="front"                           default="false"/>
  <arg name="back"                            default="true"/>
  <arg name="third"                            default="true"/>
  <arg name="fourth"                            default="true"/>
  <arg name="lidar"                           default="true"/>
  <arg name="pointcloud" default="$(arg front)" />
  <arg name="decimation" default="8"/>

  <include if="$(arg lidar)" file="$(find lunabot_perception)/launch/lidar.launch" />


  <group unless="$(arg sim)">

    <!-- IMU -->
    <node name="imu" pkg="lunabot_perception" type="imu_node" output="screen">
      <param name="imu_frame_id" type="string" value="d455_back" />
      <param name="topic_name" type="string" value="/imu" />
    </node>

    <group ns="d455_front" if="$(arg front)">
      <include file="$(find realsense2_camera)/launch/rs_rgbd.launch">
        <arg name="manager" value="front_realsense2_camera_manager" />
        <arg name="serial_no" value="$(arg serial_no_d455_front)" />
        <arg name="tf_prefix" value="d455_front" />
        <arg name="filters" value="disparity,decimation" />
        <arg name="align_depth" value="true" />
        <arg name="depth_width" value="$(arg width)" />
        <arg name="depth_height" value="$(arg height)" />
        <arg name="depth_fps" value="$(arg fps)" />
        <arg name="color_width" value="$(arg width)" />
        <arg name="color_height" value="$(arg height)" />
        <arg name="color_fps" value="$(arg fps)" />
        <arg name="enable_color" value="true"/>
        <arg name="enable_gyro" value="false" />
        <arg name="enable_accel" value="false" />
        <arg name="enable_sync" value="true" />
        <arg name="publish_tf" value="true" />
        <arg name="enable_pointcloud" value="$(arg pointcloud)" />
        <arg name="tf_publish_rate" value="0"/>
        <arg name="rgb_processing" value="false"/>

      </include>
    </group>

    <group ns="d435_right" if="$(arg third)">
      <include file="$(find realsense2_camera)/launch/rs_rgbd.launch">
        <arg name="manager" value="front_realsense2_camera_manager" />
        <arg name="serial_no" value="$(arg serial_no_d435_right)" />
        <arg name="tf_prefix" value="d435_right" />
        <arg name="filters" value="disparity,decimation" />
        <arg name="align_depth" value="true" />
        <arg name="depth_width" value="$(arg width)" />
        <arg name="depth_height" value="$(arg height)" />
        <arg name="depth_fps" value="$(arg fps)" />
        <arg name="color_width" value="$(arg width)" />
        <arg name="color_height" value="$(arg height)" />
        <arg name="color_fps" value="$(arg fps)" />
        <arg name="enable_color" value="true"/>
        <arg name="enable_gyro" value="false" />
        <arg name="enable_accel" value="false" />
        <arg name="enable_sync" value="true" />
        <arg name="publish_tf" value="true" />
        <arg name="enable_pointcloud" value="$(arg pointcloud)" />
        <arg name="tf_publish_rate" value="0"/>
        <arg name="rgb_processing" value="false"/>
      </include>
    </group>

    <group ns="d435_left" if="$(arg fourth)">
      <include file="$(find realsense2_camera)/launch/rs_rgbd.launch">
        <arg name="manager" value="front_realsense2_camera_manager" />
        <arg name="serial_no" value="$(arg serial_no_d435_left)" />
        <arg name="tf_prefix" value="d435_left" />
        <arg name="filters" value="disparity,decimation" />
        <arg name="align_depth" value="true" />
        <arg name="depth_width" value="$(arg width)" />
        <arg name="depth_height" value="$(arg height)" />
        <arg name="depth_fps" value="$(arg fps)" />
        <arg name="color_width" value="$(arg width)" />
        <arg name="color_height" value="$(arg height)" />
        <arg name="color_fps" value="$(arg fps)" />
        <arg name="enable_color" value="true"/>
        <arg name="enable_gyro" value="false" />
        <arg name="enable_accel" value="false" />
        <arg name="enable_sync" value="true" />
        <arg name="publish_tf" value="true" />
        <arg name="enable_pointcloud" value="$(arg pointcloud)" />
        <arg name="tf_publish_rate" value="0"/>
        <arg name="rgb_processing" value="false"/>
      </include>
    </group>

    <group ns="d455_back" if="$(arg back)">
      <include file="$(find realsense2_camera)/launch/rs_rgbd.launch">
        <arg name="manager" value="back_realsense2_camera_manager" />
        <arg name="serial_no" value="$(arg serial_no_d455_back)" />
        <arg name="tf_prefix" value="d455_back" />
        <arg name="filters" value="disparity,decimation" />
        <arg name="align_depth" value="true" />
        <arg name="depth_width" value="$(arg width)" />
        <arg name="depth_height" value="$(arg height)" />
        <arg name="depth_fps" value="$(arg fps)" />
        <arg name="color_width" value="$(arg width)" />
        <arg name="color_height" value="$(arg height)" />
        <arg name="color_fps" value="$(arg fps)" />
        <arg name="enable_gyro" value="false" />
        <arg name="enable_accel" value="false" />
        <arg name="enable_sync" value="true" />
        <arg name="publish_tf" value="true" />
        <arg name="enable_pointcloud" value="$(arg pointcloud)" />
        <arg name="tf_publish_rate" value="0"/>
        <arg name="rgb_processing" value="false"/>
      </include>
      <group ns="camera/color">
        <node pkg="image_proc" type="image_proc" name="image_proc"
          args="image:=camera/color/image_raw" />
        <include file="$(find lunabot_perception)/launch/apriltag.launch">
          <arg name="camera_frame" value="d455_back_base" />
        </include>
      </group>
    </group>


    <group if="$(arg lidar)">
      <node ns="pointcloud" pkg="nodelet" type='nodelet' name='point_cloud_assembler'
          args = "standalone rtabmap_util/point_cloud_assembler">
        <remap from="cloud" to="combined_cloud"/>
        <param name="fixed_frame_id" value="base_link" />
        <param name="circular_buffer" value="true"/>
        <param name="max_clouds" value="100"/>
      </node>
    </group>

    <group if="$(arg front)">
      <node ns="pointcloud" pkg="nodelet" type='nodelet' name="point_cloud_aggregator"
          args="standalone rtabmap_util/point_cloud_aggregator">
          <remap from="cloud1" to="/d455_back/camera/depth/color/points" />
          <remap from="cloud2" to="/d455_front/camera/depth/color/points" />
          <remap from="cloud3" to="/d435_right/camera/depth/color/points" />
          <remap from="cloud4" to="/d435_left/camera/depth/color/points" />
          <remap from="cloud5" to="/lidar_cloud" />
          <param name="count" value="4" unless="$(arg lidar)"/>
          <param name="count" value="5" if="$(arg lidar)"/>
          <param name="xyz_output" value="true"/>
          <param name="fixed_frame_id" value="base_link" />

      </node>
    </group>
  </group>

  <group if="$(arg sim)">
    <group ns="d435_forward/color" if="$(arg front)">
      <node pkg="image_proc" type="image_proc" name="image_proc" />
      <include file="$(find lunabot_perception)/launch/apriltag.launch">
        <arg name="camera_frame" value="d435_forward_link" />
      </include>
    </group>

    <group ns="d435_backward/color" if="$(arg back)">
      <node pkg="image_proc" type="image_proc" name="image_proc" />
      <include file="$(find lunabot_perception)/launch/apriltag.launch">
        <arg name="camera_frame" value="d435_backward_link" />
      </include>
    </group>
  </group>
</launch>
