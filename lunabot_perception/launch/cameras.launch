<?xml version="1.0"?>
<launch>
  <arg name="serial_no_d455_back"    			    default="053122251286"/> 		
  <arg name="serial_no_d435_left"    			  default="141222070808"/> 	
  <arg name="serial_no_d455_front"    			  default="053122251335"/> 	
  <arg name="serial_no_d435_right"    			  default="939622074382"/> 	
  
  <arg name="initial_reset"                   default="true"/>
  <arg name="sim"                             default="false"/>
  <arg name="width"                           default="424"/>
  <arg name="height"                          default="240"/>
  <arg name="fps"                             default="15"/>
  <arg name="front"                           default="true"/>
  <arg name="back"                            default="true"/>
  <arg name="extras"                            default="true"/>
  <arg name="pointcloud" default="$(eval arg('front') and arg('back'))" />
  
  <arg name="decimation" default="4"/>
  <arg name="voxel_size" default="0.01"/> <!--meters-->
  <arg name="noise_filter_radius" default="0.1"/> <!--meters radius-->
  <arg name="max_depth" default="3"/> <!--meters-->

  <group unless="$(arg sim)">

    <!-- IMU -->
    <node name="imu" pkg="lunabot_perception" type="imu_node" output="screen">
      <param name="imu_frame_id" type="string" value="d455_back" />
      <param name="topic_name" type="string" value="/imu" />
    </node>



    <!-- Front Camera -->
    <group ns="d455_front/camera" if="$(arg front)">

      <!-- Launch the camera device nodelet-->
      <include file="$(find realsense2_camera)/launch/includes/nodelet.launch.xml">
        <arg name="external_manager"         value="false"/>
        <arg name="manager"                  value="front_realsense2_camera_manager"/>
        <arg name="tf_prefix"                value="d455_front"/>
        <arg name="serial_no"                value="$(arg serial_no_d455_front)"/>

        <arg name="initial_reset"            value="true"/>

        <arg name="enable_pointcloud"        value="false"/>
        <arg name="enable_sync"              value="true"/>
        <arg name="align_depth"              value="true"/>

        <arg name="depth_width"              value="$(arg width)"/>
        <arg name="depth_height"             value="$(arg height)"/>
        <arg name="enable_depth"             value="true"/>

        <arg name="color_width"              value="$(arg width)"/>
        <arg name="color_height"             value="$(arg height)"/>
        <arg name="enable_color"             value="true"/>

        <arg name="depth_fps"                value="$(arg fps)"/>
        <arg name="color_fps"                value="$(arg fps)"/>
        <arg name="filters"                  value="disparity,decimation"/>

        <arg name="publish_tf"               value="true"/>
        <arg name="tf_publish_rate"          value="0"/>

        <arg name="clip_distance"            value="-1"/>
      </include>

      <!-- RGB processing -->
      <!-- Color rectified image -->
      <node pkg="nodelet" type="nodelet" name="color_rectify_color"
            args="load image_proc/rectify front_realsense2_camera_manager false"
            respawn="false">
        <param name="queue_size" value="5" />
        <remap from="image_mono" to="color/image_raw" />
        <remap from="image_rect" to="color/image_rect_color" />
      </node>

      <!-- Publish registered XYZ only point cloud using RTabMap's formula -->
      <node if="$(arg pointcloud)" pkg="nodelet" type="nodelet" name="points_xyz_rtabmap"
            args="standalone rtabmap_util/point_cloud_xyz" respawn="false">
        <remap from="depth/camera_info"             to="aligned_depth_to_color/camera_info" />
        <remap from="depth/image" to="aligned_depth_to_color/image_raw" />
        <remap from="cloud"     to="points" /> <!-- output-->

        <!-- reduce pointcloud size -->
        <param name="decimation" type="int" value="$(arg decimation)"/>
        <param name="voxel_size" type="double" value="$(arg voxel_size)"/>
        <param name="noise_filter_radius" type="double" value="$(arg noise_filter_radius)"/>
        <param name="max_depth" type="double" value="$(arg max_depth)"/>
      </node>

      <group ns="color">
        <node pkg="image_proc" type="image_proc" name="image_proc"
          args="image:=camera/color/image_raw" />
        <include file="$(find lunabot_perception)/launch/apriltag.launch">
          <arg name="camera_frame" value="d455_back_base" />
        </include>
      </group>

    </group>

    <!-- Back Camera -->
    <group ns="d455_back/camera" if="$(arg back)">

      <!-- Launch the camera device nodelet-->
      <include file="$(find realsense2_camera)/launch/includes/nodelet.launch.xml">
        <arg name="external_manager"         value="false"/>
        <arg name="manager"                  value="back_realsense2_camera_manager"/>
        <arg name="tf_prefix"                value="d455_back"/>
        <arg name="serial_no"                value="$(arg serial_no_d455_back)"/>

        <arg name="initial_reset"            value="true"/>

        <arg name="enable_pointcloud"        value="false"/>
        <arg name="enable_sync"              value="true"/>
        <arg name="align_depth"              value="true"/>

        <arg name="depth_width"              value="$(arg width)"/>
        <arg name="depth_height"             value="$(arg height)"/>
        <arg name="enable_depth"             value="true"/>

        <arg name="color_width"              value="$(arg width)"/>
        <arg name="color_height"             value="$(arg height)"/>
        <arg name="enable_color"             value="true"/>

        <arg name="depth_fps"                value="$(arg fps)"/>
        <arg name="color_fps"                value="$(arg fps)"/>
        <arg name="filters"                  value="disparity,decimation"/>

        <arg name="publish_tf"               value="true"/>
        <arg name="tf_publish_rate"          value="0"/>

        <arg name="clip_distance"            value="-1"/>
      </include>

      <!-- RGB processing -->
      <!-- Color rectified image -->
      <node pkg="nodelet" type="nodelet" name="color_rectify_color"
            args="load image_proc/rectify back_realsense2_camera_manager false"
            respawn="false">
        <param name="queue_size" value="5" />
        <remap from="image_mono" to="color/image_raw" />
        <remap from="image_rect" to="color/image_rect_color" />
      </node>

      <!-- Publish registered XYZ only point cloud using RTabMap's formula -->
      <node if="$(arg pointcloud)" pkg="nodelet" type="nodelet" name="point_cloud_xyz"
            args="standalone rtabmap_util/point_cloud_xyz" respawn="false">
        <remap from="depth/camera_info"             to="aligned_depth_to_color/camera_info" />
        <remap from="depth/image" to="aligned_depth_to_color/image_raw" />
        <remap from="cloud"     to="points" /> <!-- output-->

        <!-- reduce pointcloud size -->
        <param name="decimation" type="int" value="$(arg decimation)"/>
        <param name="voxel_size" type="double" value="$(arg voxel_size)"/>
        <param name="noise_filter_radius" type="double" value="$(arg noise_filter_radius)"/>
        <param name="max_depth" type="double" value="$(arg max_depth)"/>
        <param name="roi_ratios" type="string" value="0.0 0.0 0.0 0.0"/> <!--Remove top 25%-->
      </node>

      <group ns="color">
        <node pkg="image_proc" type="image_proc" name="image_proc"
          args="image:=camera/color/image_raw" />
        <include file="$(find lunabot_perception)/launch/apriltag.launch">
          <arg name="camera_frame" value="d455_back_base" />
        </include>
      </group>

    </group>


    <group ns="d435_right/camera" if="$(arg extras)">

      <!-- Launch the camera device nodelet-->
      <include file="$(find realsense2_camera)/launch/includes/nodelet.launch.xml">
        <arg name="external_manager"         value="false"/>
        <arg name="manager"                  value="right_realsense2_camera_manager"/>
        <arg name="tf_prefix"                value="d435_right"/>
        <arg name="serial_no"                value="$(arg serial_no_d435_right)"/>

        <arg name="initial_reset"            value="true"/>

        <arg name="enable_pointcloud"        value="false"/>
        <arg name="enable_sync"              value="false"/>
        <arg name="align_depth"              value="false"/>

        <arg name="enable_depth"             value="false"/>

        <arg name="color_width"              value="$(arg width)"/>
        <arg name="color_height"             value="$(arg height)"/>
        <arg name="enable_color"             value="true"/>

        <arg name="color_fps"                value="$(arg fps)"/>
        <arg name="filters"                  value=""/>

        <arg name="publish_tf"               value="true"/>
        <arg name="tf_publish_rate"          value="0"/>
      </include>
      <group ns="color">
        <node pkg="image_proc" type="image_proc" name="image_proc"
          args="image:=camera/color/image_raw" />
        <include file="$(find lunabot_perception)/launch/apriltag.launch">
          <arg name="camera_frame" value="d435_right_base" />
        </include>
      </group>
    </group>

    <group ns="d435_left/camera" if="$(arg extras)">
      <!-- Launch the camera device nodelet-->
      <include file="$(find realsense2_camera)/launch/includes/nodelet.launch.xml">
        <arg name="external_manager"         value="false"/>
        <arg name="manager"                  value="left_realsense2_camera_manager"/>
        <arg name="tf_prefix"                value="d435_left"/>
        <arg name="serial_no"                value="$(arg serial_no_d435_left)"/>

        <arg name="initial_reset"            value="true"/>


        <arg name="enable_pointcloud"        value="false"/>
        <arg name="enable_sync"              value="false"/>
        <arg name="align_depth"              value="false"/>

        <arg name="enable_depth"             value="false"/>

        <arg name="color_width"              value="$(arg width)"/>
        <arg name="color_height"             value="$(arg height)"/>
        <arg name="enable_color"             value="true"/>

        <arg name="color_fps"                value="$(arg fps)"/>
        <arg name="filters"                  value=""/>

        <arg name="publish_tf"               value="true"/>
        <arg name="tf_publish_rate"          value="0"/>
      </include>
      <group ns="color">
        <node pkg="image_proc" type="image_proc" name="image_proc"
          args="image:=camera/color/image_raw" />
        <include file="$(find lunabot_perception)/launch/apriltag.launch">
          <arg name="camera_frame" value="d435_left_base" />
        </include>
      </group>
    </group>



    <!-- Aggregate pointclouds from each camera (if using multiple cameras)-->
    <node if="$(arg pointcloud)" ns="pointcloud" pkg="nodelet" type='nodelet' name="point_cloud_aggregator"
        args="standalone rtabmap_util/point_cloud_aggregator">
        <remap from="cloud1" to="/d455_back/camera/points" />
        <remap from="cloud2" to="/d455_front/camera/points" />
        <remap from="combined_cloud" to="depth_combined_cloud"/>       
        <param name="count" value="2"/>
        <param name="xyz_output" value="true"/>
        <param name="fixed_frame_id" value="base_link" />
        <param name="approx_sync" value="true"/>
    </node>
  </group>

  <group if="$(arg sim)">
    <group ns="d435_forward/color" if="$(arg front)">
      <node pkg="image_proc" type="image_proc" name="image_proc" />
      <include file="$(find lunabot_perception)/launch/apriltag.launch">
        <arg name="camera_frame" value="d435_forward_link" />
      </include>
    </group>

    <group ns="d435_backward/color" if="$(arg back)">
      <node pkg="image_proc" type="image_proc" name="image_proc" />
      <include file="$(find lunabot_perception)/launch/apriltag.launch">
        <arg name="camera_frame" value="d435_backward_link" />
      </include>
    </group>
  </group>
</launch>
